<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>モノクロ実績ダッシュボード</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    <h1>実績ダッシュボード</h1>
  </header>

  <!-- タブボタン -->
  <nav class="tab-buttons">
    <button id="btn-dashboard" class="active">ダッシュボード</button>
    <button id="btn-all-records">全ての記録</button>
  </nav>

  <main class="tab-content">
    <!-- ダッシュボードタブ -->
    <section id="dashboard-tab" class="active">
      <section id="latest-records" class="card">
        <h2>直近の記録</h2>
        <table id="latest-table"></table>
      </section>

      <section id="top-performers" class="card">
        <h2>成績の良いもの</h2>
        <table id="top-table"></table>
      </section>

      <section id="graph-section" class="card">
        <h2>実績推移グラフ</h2>
        <canvas id="performance-chart"></canvas>
      </section>

      <section id="weekday-average" class="card">
        <h2>曜日別平均クリアステージ数</h2>
        <table id="weekday-table"></table>
        <canvas id="weekday-chart"></canvas>
      </section>

      <section id="hourly-average" class="card">
        <h2>時間帯別平均クリアステージ数</h2>
        <table id="hourly-table"></table>
        <canvas id="hourly-chart"></canvas>
      </section>
    </section>

    <!-- 全記録タブ -->
    <section id="all-records-tab">
      <div class="card">
        <h2>総プレイ回数</h2>
        <p id="total-count" class="fade-in-text">0 件</p>
      </div>
      <section class="card">
        <h2>全ての記録一覧</h2>
        <table id="all-records-table"></table>
      </section>
    </section>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const btnDash = document.getElementById('btn-dashboard');
      const btnAll   = document.getElementById('btn-all-records');
      const dashTab  = document.getElementById('dashboard-tab');
      const allTab   = document.getElementById('all-records-tab');

      // タブ切り替えイベント
      btnDash.addEventListener('click', () => {
        btnDash.classList.add('active');
        btnAll.classList.remove('active');
        dashTab.classList.add('active');
        allTab.classList.remove('active');
      });
      btnAll.addEventListener('click', () => {
        btnAll.classList.add('active');
        btnDash.classList.remove('active');
        allTab.classList.add('active');
        dashTab.classList.remove('active');
      });

      // データ読み込み
      fetch('data.json')
        .then(res => res.json())
        .then(data => {
          const records = data.records;
          renderLatest(records);
          renderTop(records);
          renderChart(records);
          renderWeekdayAverage(records);
          renderHourlyAverage(records);
          renderAllRecords(records);
        })
        .catch(err => console.error(err));
    });

    // ---- 既存の描画関数 ----

    function renderLatest(records) {
      const sorted = [...records]
        .sort((a,b) => new Date(b.date) - new Date(a.date))
        .slice(0,5);
      const table = document.getElementById('latest-table');
      table.innerHTML = `
        <thead>
          <tr>
            <th>日付</th><th>曜日</th><th>開始時刻</th>
            <th>クリアステージ数</th><th>備考1</th>
            <th>備考2</th><th>備考3</th>
          </tr>
        </thead>`;
      const tbody = document.createElement('tbody');
      sorted.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.date}</td><td>${r.weekday}</td>
          <td>${r.startTime}</td><td>${r.clearStages}</td>
          <td>${r.remark1||''}</td><td>${r.remark2||''}</td>
          <td>${r.remark3||''}</td>`;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
    }

    function renderTop(records) {
      const sorted = [...records]
        .sort((a,b) => b.clearStages - a.clearStages)
        .slice(0,5);
      const table = document.getElementById('top-table');
      table.innerHTML = `
        <thead>
          <tr>
            <th>日付</th><th>曜日</th><th>開始時刻</th>
            <th>クリアステージ数</th><th>備考1</th>
            <th>備考2</th><th>備考3</th>
          </tr>
        </thead>`;
      const tbody = document.createElement('tbody');
      sorted.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.date}</td><td>${r.weekday}</td>
          <td>${r.startTime}</td><td>${r.clearStages}</td>
          <td>${r.remark1||''}</td><td>${r.remark2||''}</td>
          <td>${r.remark3||''}</td>`;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
    }

    function renderChart(records) {
      const labels = records.map(r => r.date);
      const dataPoints = records.map(r => r.clearStages);
      const ctx = document.getElementById('performance-chart').getContext('2d');
      new Chart(ctx, {
        type:'line',
        data:{ labels, datasets:[{
          label:'クリアステージ数推移',
          data:dataPoints,
          borderColor:'#111',
          backgroundColor:'rgba(0,0,0,0.1)',
          tension:0.3
        }]},
        options:{ animation:{ duration:1200 } }
      });
    }

    function renderWeekdayAverage(records) {
      const days=['月','火','水','木','金','土','日'];
      const agg = days.reduce((o,d)=>{ o[d]={sum:0,count:0};return o; },{});
      records.forEach(r=>{
        if(agg[r.weekday]){
          agg[r.weekday].sum += r.clearStages;
          agg[r.weekday].count++;
        }
      });
      const labels=[], avgs=[];
      const table = document.getElementById('weekday-table');
      table.innerHTML = `
        <thead><tr><th>曜日</th><th>平均クリアステージ数</th></tr></thead>`;
      const tbody=document.createElement('tbody');
      days.forEach(d=>{
        const {sum,count}=agg[d];
        const avg = count? (sum/count).toFixed(2) : '–';
        labels.push(d);
        avgs.push(count? parseFloat(avg): 0);
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${d}</td><td>${avg}</td>`;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      const ctx=document.getElementById('weekday-chart').getContext('2d');
      new Chart(ctx,{
        type:'bar',
        data:{ labels, datasets:[{
          label:'曜日別平均',
          data:avgs,
          backgroundColor:'rgba(0,0,0,0.2)',
          borderColor:'#111', borderWidth:1
        }]},
        options:{ scales:{ y:{ beginAtZero:true } } }
      });
    }

    function renderHourlyAverage(records) {
      const hours=Array.from({length:24},(_,i)=>i);
      const agg=hours.reduce((o,h)=>{ o[h]={sum:0,count:0};return o; },{});
      records.forEach(r=>{
        const h=parseInt(r.startTime.split(':')[0],10);
        if(!isNaN(h) && agg[h]){
          agg[h].sum += r.clearStages;
          agg[h].count++;
        }
      });
      const labels=[], avgs=[];
      const table=document.getElementById('hourly-table');
      table.innerHTML = `
        <thead><tr><th>時間帯</th><th>平均クリアステージ数</th></tr></thead>`;
      const tbody=document.createElement('tbody');
      hours.forEach(h=>{
        const {sum,count}=agg[h];
        const avg = count? (sum/count).toFixed(2) : '–';
        labels.push(`${('0'+h).slice(-2)}:00`);
        avgs.push(count? parseFloat(avg): 0);
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${('0'+h).slice(-2)}:00</td><td>${avg}</td>`;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      const ctx=document.getElementById('hourly-chart').getContext('2d');
      new Chart(ctx,{
        type:'bar',
        data:{ labels, datasets:[{
          label:'時間帯別平均',
          data:avgs,
          backgroundColor:'rgba(0,0,0,0.2)',
          borderColor:'#111', borderWidth:1
        }]},
        options:{ scales:{ y:{ beginAtZero:true } } }
      });
    }

    // 全記録一覧と総プレイ回数
    function renderAllRecords(records) {
      // 総件数
      const totalEl = document.getElementById('total-count');
      totalEl.textContent = `${records.length} 件`;

      // 全レコードテーブル
      const table = document.getElementById('all-records-table');
      table.innerHTML = `
        <thead>
          <tr>
            <th>日付</th><th>曜日</th><th>開始時刻</th>
            <th>クリアステージ数</th><th>備考1</th>
            <th>備考2</th><th>備考3</th>
          </tr>
        </thead>`;
      const tbody = document.createElement('tbody');
      records.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.date}</td><td>${r.weekday}</td>
          <td>${r.startTime}</td><td>${r.clearStages}</td>
          <td>${r.remark1||''}</td><td>${r.remark2||''}</td>
          <td>${r.remark3||''}</td>`;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
    }
  </script>
</body>
</html>
